#include <machine.h>
#include "types.h"
#include "flash.h"

static const u8 far unk00[] = {
    0x4D, 0x53, 0x01, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 
};

static const u8 far unk01[] = {
    0x0E, 0xBE, 0xB0, 0xCC, 0xDE, 0xC3, 0xDE, 0xB0, 0xC0, 0x0F, 0xA6, 0x20, 0xBC, 0xAE, 0xB7, 0xB6,
    0xBC, 0xCF, 0xBC, 0xC0, 0x00
};

static const u8 far unk02[] = {
    0x53, 0x54, 0x41, 0x52, 0x54, 0x0E, 0xCE, 0xDE, 0xC0, 0xDD, 0x0F, 0xC3, 0xDE, 0x0E, 0xB9, 0xDE,
    0xB0, 0xD1, 0x0F, 0xC6, 0xD3, 0xC4, 0xDE, 0xD8, 0xCF, 0xBD, 0x00 
};

void stage_get()
{
	ASM_INLINE("PUSH	CX");
	ASM_INLINE("PUSH	DX");
	ASM_INLINE("PUSH	SI");
	ASM_INLINE("MOV	CX,AX");
	ASM_INLINE("MOV	SI,0x000F");
	ASM_INLINE("JMP	_9175C");
ASM_INLINE("_9173F:");
	ASM_INLINE("MOV	AX,CX");
	ASM_INLINE("MOV	BX,0x001D");
	ASM_INLINE("MUL	BX");
	ASM_INLINE("MOV	BX,AX");
	ASM_INLINE("ADD	BX,0x1E3C");
	ASM_INLINE("ADD	BX,0x000D");
	ASM_INLINE("ADD	BX,SI");
	ASM_INLINE("CMP	[BX].B,0x00");
	ASM_INLINE("JZ	_9175B");
	ASM_INLINE("INC	SI");
	ASM_INLINE("MOV	AX,SI");
	ASM_INLINE("JMP	_91763");
ASM_INLINE("_9175B:");
	ASM_INLINE("DEC	SI");
ASM_INLINE("_9175C:");
	ASM_INLINE("CMP	SI,0x0000");
	ASM_INLINE("JGE	_9173F");
	ASM_INLINE("XOR	AX,AX");
ASM_INLINE("_91763:");
	ASM_INLINE("POP	SI");
	ASM_INLINE("POP	DX");
	ASM_INLINE("POP	CX");
}

void hstrlen()
{
	ASM_INLINE("PUSH	SI");
	ASM_INLINE("MOV	SI,AX");
	ASM_INLINE("XOR	AX,AX");
	ASM_INLINE("JMP	_9177C");
ASM_INLINE("_9176E:");
	ASM_INLINE("MOV	BL,[SI].B");
	ASM_INLINE("CMP	BL,0x0F");
	ASM_INLINE("JZ	_9177B");
	ASM_INLINE("CMP	BL,0x0E");
	ASM_INLINE("JZ	_9177B");
	ASM_INLINE("INC	AX");
ASM_INLINE("_9177B:");
	ASM_INLINE("INC	SI");
ASM_INLINE("_9177C:");
	ASM_INLINE("CMP	[SI].B,0x00");
	ASM_INLINE("JNZ	_9176E");
	ASM_INLINE("POP	SI");
}

void flash_clear()
{
	ASM_INLINE("PUSH	BP");
	ASM_INLINE("MOV	BP,SP");
	ASM_INLINE("SUB	SP,0x0004");
	ASM_INLINE("PUSH	CX");
	ASM_INLINE("PUSH	SI");
	ASM_INLINE("MOV	SI,0x1E00");
	ASM_INLINE("MOV	[BP-0x04].W,0x0000");
	ASM_INLINE("MOV	[BP-0x02].W,0xE42F");
	ASM_INLINE("MOV	CX,0x015E");
	ASM_INLINE("JMP	_917AA");
ASM_INLINE("_9179D:");
	ASM_INLINE("INC	[BP-0x04].W");
	ASM_INLINE("LES	BX,[BP-0x04]");
	ASM_INLINE("DEC	BX");
	ASM_INLINE("MOV	AL,ES:[BX].B");
	ASM_INLINE("MOV	[SI].B,AL");
	ASM_INLINE("INC	SI");
ASM_INLINE("_917AA:");
	ASM_INLINE("DEC	CX");
	ASM_INLINE("MOV	AX,CX");
	ASM_INLINE("INC	AX");
	ASM_INLINE("JNZ	_9179D");
	ASM_INLINE("POP	SI");
	ASM_INLINE("POP	CX");
	ASM_INLINE("MOV	SP,BP");
	ASM_INLINE("POP	BP");
}

void flash_init()
{
	ASM_INLINE("PUSH	BP");
	ASM_INLINE("MOV	BP,SP");
	ASM_INLINE("SUB	SP,0x0004");
	ASM_INLINE("PUSH	CX");
	ASM_INLINE("PUSH	SI");
	ASM_INLINE("MOV	SI,0x1E00");
	ASM_INLINE("MOV	[BP-0x04].W,0x0000");
	ASM_INLINE("MOV	[BP-0x02].W,0xE42F");
	ASM_INLINE("MOV	AX,0x0004");
	ASM_INLINE("MOV	CX,0x0004");
	ASM_INLINE("JMP	_917E3");
ASM_INLINE("_917D3:");
	ASM_INLINE("MOV	AL,[SI].B");
	ASM_INLINE("INC	SI");
	ASM_INLINE("INC	[BP-0x04].W");
	ASM_INLINE("LES	BX,[BP-0x04]");
	ASM_INLINE("DEC	BX");
	ASM_INLINE("CMP	AL,ES:[BX].B");
	ASM_INLINE("JNZ	_917E7");
	ASM_INLINE("DEC	CX");
ASM_INLINE("_917E3:");
	ASM_INLINE("TEST	CX,CX");
	ASM_INLINE("JNZ	_917D3");
ASM_INLINE("_917E7:");
	ASM_INLINE("CALLF	0x0274, 0x800A");
	ASM_INLINE("TEST	CX,CX");
	ASM_INLINE("JZ	_91830");
	ASM_INLINE("CALLF	0x0053, 0x9173");
	ASM_INLINE("MOV	AX,0x0106");
	ASM_INLINE("MOV	BX,0x9173");
	ASM_INLINE("XOR	CX,CX");
	ASM_INLINE("CALLF	0x01F7, 0x800A");
	ASM_INLINE("XOR	AX,AX");
	ASM_INLINE("CALLF	0x0370, 0x80EB");
	ASM_INLINE("MOV	AX,0x000A");
	ASM_INLINE("CALLF	0x0374, 0x80EB");
	ASM_INLINE("CALLF	0x032E, 0x80EB");
	ASM_INLINE("MOV	AX,0x0001");
	ASM_INLINE("CALLF	0x015E, 0x918E");
	ASM_INLINE("MOV	AX,0x0001");
	ASM_INLINE("MOV	BX,0x0001");
	ASM_INLINE("CALLF	0x0007, 0x80EB");
	ASM_INLINE("MOV	AL,0x0F");
	ASM_INLINE("CALLF	0x009F, 0x8000");
ASM_INLINE("_91830:");
	ASM_INLINE("POP	SI");
	ASM_INLINE("POP	CX");
	ASM_INLINE("MOV	SP,BP");
	ASM_INLINE("POP	BP");
}

static void unk_91836()
{
	ASM_INLINE("PUSH	BP");
	ASM_INLINE("MOV	BP,SP");
	ASM_INLINE("SUB	SP,0x0040");
	ASM_INLINE("PUSH	CX");
	ASM_INLINE("PUSH	DX");
	ASM_INLINE("PUSH	SI");
	ASM_INLINE("PUSH	DI");
	ASM_INLINE("MOV	DI,0x0040");
	ASM_INLINE("XOR	SI,SI");
	ASM_INLINE("JMP	_91848");
ASM_INLINE("_91847:");
	ASM_INLINE("INC	SI");
ASM_INLINE("_91848:");
	ASM_INLINE("MOV	AX,0xE444");
	ASM_INLINE("MOV	ES,AX");
	//ASM_INLINE("MOV	AL,ES:[SI+0x000E].B");
	ASM_OP5(0x26,0x8A,0x84,0x0E,0x00);
	//ASM_INLINE("MOV	[BP+SI-0x40].B,AL");
	ASM_INLINE("MOV	-0x40[BP+SI].B,AL");
	ASM_INLINE("TEST	AL,AL");
	ASM_INLINE("JNZ	_91847");
	ASM_INLINE("LEA	AX,[BP-0x40].B");
	ASM_INLINE("CALLF	0x0037, 0x9173");
	ASM_INLINE("SHL	AX,1");
	ASM_INLINE("SHL	AX,1");
	ASM_INLINE("SHL	AX,1");
	ASM_INLINE("MOV	BX,0x00E0");
	ASM_INLINE("SUB	BX,AX");
	ASM_INLINE("SAR	BX,1");
	ASM_INLINE("XOR	AX,AX");
	ASM_INLINE("PUSH	AX");
	ASM_INLINE("MOV	AX,BX");
	ASM_INLINE("MOV	BX,DI");
	ASM_INLINE("LEA	CX,[BP-0x40].B");
	ASM_INLINE("MOV	DX,0x0001");
	ASM_INLINE("CALLF	0x0094, 0x8053");
	ASM_INLINE("ADD	SP,0x0002");
	ASM_INLINE("XOR	SI,SI");
	ASM_INLINE("JMP	_91888");
ASM_INLINE("_91887:");
	ASM_INLINE("INC	SI");
ASM_INLINE("_91888:");
	ASM_INLINE("MOV	AX,0xE446");
	ASM_INLINE("MOV	ES,AX");
	//ASM_INLINE("MOV	AL,ES:[SI+0x0004].B");
	ASM_OP5(0x26,0x8A,0x84,0x04,0x00);
	//ASM_INLINE("MOV	[BP+SI-0x40].B,AL");
	ASM_INLINE("MOV	-040h[BP+SI].B,AL");
	ASM_INLINE("TEST	AL,AL");
	ASM_INLINE("JNZ	_91887");
	ASM_INLINE("LEA	AX,[BP-0x40].B");
	ASM_INLINE("CALLF	0x0037, 0x9173");
	ASM_INLINE("SHL	AX,1");
	ASM_INLINE("SHL	AX,1");
	ASM_INLINE("SHL	AX,1");
	ASM_INLINE("MOV	BX,0x00E0");
	ASM_INLINE("SUB	BX,AX");
	ASM_INLINE("SAR	BX,1");
	ASM_INLINE("XOR	AX,AX");
	ASM_INLINE("PUSH	AX");
	ASM_INLINE("MOV	AX,BX");
	ASM_INLINE("ADD	DI,0x0008");
	ASM_INLINE("MOV	BX,DI");
	ASM_INLINE("LEA	CX,[BP-0x40].B");
	ASM_INLINE("MOV	DX,0x0001");
	ASM_INLINE("CALLF	0x0094, 0x8053");
	ASM_INLINE("ADD	SP,0x0002");
	ASM_INLINE("TEST	[0x0956].W,0x0002");
	ASM_INLINE("JZ	_918E2");
	ASM_INLINE("MOV	AL,0x0A");
	ASM_INLINE("CALLF	0x009F, 0x8000");
	ASM_INLINE("CALLF	0x0274, 0x800A");
	ASM_INLINE("MOV	AX,0x000A");
	ASM_INLINE("CALLF	0x02B0, 0x800A");
ASM_INLINE("_918E2:");
	ASM_INLINE("POP	DI");
	ASM_INLINE("POP	SI");
	ASM_INLINE("POP	DX");
	ASM_INLINE("POP	CX");
	ASM_INLINE("MOV	SP,BP");
	ASM_INLINE("POP	BP");
}

 