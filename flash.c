#include <machine.h>
#include "types.h"
#include "flash.h"
#include "SWAN_L_C.h"
#include "SWANMAIN.h"
#include "SPRINTF.h"
#include "SYSTEM.h"
#include "SOUND_CODE.h"
#include "MEMORY.h"
#include "PAD.h"
#include "story.h"

static const u8 far unk00[] = {
    0x4D, 0x53, 0x01, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80,
    0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 
};

//"Save data... has been created."
static const char far unk01[] = "¥x0Eｾｰﾌﾞﾃﾞｰﾀ¥x0Fｦ ｼｮｷｶｼﾏｼﾀ";

//"START button to start the game"
static const char far unk02[] = "START¥x0Eﾎﾞﾀﾝ¥x0Fﾃﾞ¥x0Eｹﾞｰﾑ¥x0Fﾆﾓﾄﾞﾘﾏｽ";

static void unk_91836(u16 val);

u16 stage_get(u16 a)
{
	u8 *save;
	s16 i;

	i = 15;

	while(i >= 0)
	{
		save = a * 0x1D;
		save += 0x1E3C;
		save += 0xD;
		save += i;
		if(*save)
		{
			i++;
			return i;
		}
		i--;
	}
	return 0;
}

u16 hstrlen(char *str)
{
	u16 len = 0;
	u8 val;

	while(*str)
	{
		val = *str;
		if(val != 0x0F && val != 0x0E)
		{
			len++;
		}
		str++;
	}
	return len;
}

void flash_clear()
{
	u8 *save;
	u8 far *unk0;
	u16 i;

	save = SAVE_DATA_START;
	unk0 = (u8 far *)unk00;

	i = sizeof(unk00);

	while(--i+1)
	{
		*save++ = *unk0++;
	}
}

void flash_init()
{
	u8 *save;
	u8 far *unk0;
	u16 i;
	u16 j;

	save = SAVE_DATA_START;

	unk0 = (u8 far *)unk00;

	j = 4;
	i = 4;

	while(i)
	{
		if(*save++ != *unk0++) break;
		i--;
	}

	task_delete();
	if(i)
	{
		flash_clear();
		task_append((task_pointer)unk_91836, 0);
		fade_tone(0);
		fade_in(10);
		fade_run();
		bitmap(1);
		nbg_ddf(1, 1);
		sereq(15);
	}
}

static void unk_91836(u16 val)
{
	u16 i;
	s16 len;
	s16 max;
	char c;
	char str[64];

	max = 64; //might also be sizeof(str)?
	i=0;
	while (str[i] = unk01[i])
	{
		i++;
	}

	len = ((s16)(0xe0 - hstrlen(str) * 8)) >> 1;
	bmp_print(len, max, str, 1, 0);

	i=0;
	while (str[i] = unk02[i])
	{
		i++;
	}

	len = ((s16)(0xe0 - hstrlen(str) * 8)) >> 1;
	bmp_print(len, max+8, str, 1, 0);

	if (pad.unk4 & 2)
	{
		sereq(10);
		task_delete();
		task_delete_fade(10);
	}
}

 